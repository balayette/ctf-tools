commit fed72e7de05d95af8cffddcd53f66227083a0ee8
Author: Nicolas Manichon <nicolas.manichon@lse.epita.fr>
Date:   Mon Sep 23 13:31:52 2019 +0200

    Instruction counting

diff --git a/accel/tcg/cpu-exec.c b/accel/tcg/cpu-exec.c
index 2560c90eec..99a4175b81 100644
--- a/accel/tcg/cpu-exec.c
+++ b/accel/tcg/cpu-exec.c
@@ -154,4 +154,8 @@ static inline tcg_target_ulong cpu_tb_exec(CPUState *cpu, TranslationBlock *itb)
                            lookup_symbol(itb->pc));
 
+    if (unlikely(qemu_loglevel_mask(CPU_LOG_INSTR_CNT)
+                && qemu_log_in_addr_range(itb->pc)))
+        cpu->icount += itb->icount;
+
 #if defined(DEBUG_DISAS)
     if (qemu_loglevel_mask(CPU_LOG_TB_CPU)
diff --git a/cpus.c b/cpus.c
index b4f8b84b61..5085b36cb2 100644
--- a/cpus.c
+++ b/cpus.c
@@ -1864,4 +1864,5 @@ void pause_all_vcpus(void)
     qemu_clock_enable(QEMU_CLOCK_VIRTUAL, false);
     CPU_FOREACH(cpu) {
+        qemu_log_mask(CPU_LOG_INSTR_CNT, "cpu exit icount %ld\n", cpu->icount);
         if (qemu_cpu_is_self(cpu)) {
             qemu_cpu_stop(cpu, true);
diff --git a/include/hw/core/cpu.h b/include/hw/core/cpu.h
index 73e9a869a4..36cd905f5a 100644
--- a/include/hw/core/cpu.h
+++ b/include/hw/core/cpu.h
@@ -354,4 +354,6 @@ struct CPUState {
     int nr_threads;
 
+    uint64_t icount;
+
     struct QemuThread *thread;
 #ifdef _WIN32
diff --git a/include/qemu/log.h b/include/qemu/log.h
index e0f4e40628..992990a06e 100644
--- a/include/qemu/log.h
+++ b/include/qemu/log.h
@@ -63,4 +63,5 @@ static inline bool qemu_log_separate(void)
 #define CPU_LOG_TB_FPU     (1 << 17)
 #define CPU_LOG_PLUGIN     (1 << 18)
+#define CPU_LOG_INSTR_CNT  (1 << 22)
 
 /* Lock output for a series of related logs.  Since this is not needed
diff --git a/linux-user/syscall.c b/linux-user/syscall.c
index d60142f069..4db32ea5ba 100644
--- a/linux-user/syscall.c
+++ b/linux-user/syscall.c
@@ -7373,4 +7373,6 @@ static abi_long do_syscall1(void *cpu_env, int num, abi_long arg1,
             TaskState *ts;
 
+            qemu_log_mask(CPU_LOG_INSTR_CNT, "thread exit icount %ld\n", cpu->icount);
+
             /* Remove the CPU from the list.  */
             QTAILQ_REMOVE_RCU(&cpus, cpu, node);
@@ -7392,4 +7394,5 @@ static abi_long do_syscall1(void *cpu_env, int num, abi_long arg1,
 
         cpu_list_unlock();
+        qemu_log_mask(CPU_LOG_INSTR_CNT, "application exit icount %ld\n", cpu->icount);
         preexit_cleanup(cpu_env, arg1);
         _exit(arg1);
@@ -9372,4 +9375,5 @@ static abi_long do_syscall1(void *cpu_env, int num, abi_long arg1,
     case TARGET_NR_exit_group:
         preexit_cleanup(cpu_env, arg1);
+        qemu_log_mask(CPU_LOG_INSTR_CNT, "application exit icount %ld\n", cpu->icount);
         return get_errno(exit_group(arg1));
 #endif
diff --git a/util/log.c b/util/log.c
index 47f2827397..0960a15f06 100644
--- a/util/log.c
+++ b/util/log.c
@@ -333,4 +333,6 @@ const QEMULogItem qemu_log_items[] = {
     { CPU_LOG_PLUGIN, "plugin", "output from TCG plugins\n"},
 #endif
+    { CPU_LOG_INSTR_CNT | CPU_LOG_TB_NOCHAIN, "instrc",
+      "log count of executed instructions" },
     { 0, NULL, NULL },
 };
